    non2 <- matrix(c(1, 2, 3, 1, 2, 3, rep(0, 15)), ncol = 7, nrow = 3)
    non2 <- do.call(rbind, replicate(9, non2, simplify = FALSE))
    non2[, 3:7] <- matrix(sample(rep(1:3, 5)), ncol = 5)
    int2 <- matrix(c(1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, rep(0, 9)),
                   ncol = 7, nrow = 3)
    int2 <- do.call(rbind, replicate(9, int2, simplify = FALSE))
    int2[, 5:7] <- matrix(sample(rep(1:3, 3)), ncol = 3)
exp = 1
block = 4
    a3 <- c(1, 1, 1, 1, 1, 1, 0,
            1, 1, 1, 1, 2, 2, 0,
            1, 1, 1, 1, 3, 3, 0,
            1, 1, 2, 2, 1, 1, 0,
            1, 1, 2, 2, 2, 2, 0,
            1, 1, 2, 2, 3, 3, 0,
            1, 1, 3, 3, 1, 1, 0,
            1, 1, 3, 3, 2, 2, 0,
            1, 1, 3, 3, 3, 3, 0)
    b3 <- c(2, 2, 1, 1, 1, 1, 0,
            2, 2, 1, 1, 2, 2, 0,
            2, 2, 1, 1, 3, 3, 0,
            2, 2, 2, 2, 1, 1, 0,
            2, 2, 2, 2, 2, 2, 0,
            2, 2, 2, 2, 3, 3, 0,
            2, 2, 3, 3, 1, 1, 0,
            2, 2, 3, 3, 2, 2, 0,
            2, 2, 3, 3, 3, 3, 0)
    c3 <- c(3, 3, 1, 1, 1, 1, 0,
            3, 3, 1, 1, 2, 2, 0,
            3, 3, 1, 1, 3, 3, 0,
            3, 3, 2, 2, 1, 1, 0,
            3, 3, 2, 2, 2, 2, 0,
            3, 3, 2, 2, 3, 3, 0,
            3, 3, 3, 3, 1, 1, 0,
            3, 3, 3, 3, 2, 2, 0,
            3, 3, 3, 3, 3, 3, 0)
    non3 <- matrix(rbind(a3, b3, c3), ncol = 7, byrow = TRUE)
    non3[, 7] <- sample(rep(1:3, nrow(non3) / 3))
    int3 <- c(1, 1, 1, 0, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 3, 3, 3, 0, 0, 0, 0)
    int3 <- matrix(rep(int3, 9), ncol = 7, byrow = TRUE)
    int3[, 4:7] <- matrix(sample(rep(1:3, 4)), ncol = 4)
    biglist <- list(non2, int2, non3, int3)
biglist[1]
biglist[2]
biglist[[2]]
str(biglist[[2]])
str(biglist[2])
    block <- biglist[exp]
    tmp <- NULL
block
str(block)
        tmp <- replicate(tmp[sample(nrow(tmp)), ], block)
        tmp <- do.call(rbind, replicate(tmp[sample(nrow(tmp)), ], block, 
                                        simplify = FALSE))
        tmp <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
    block <- biglist[[exp]]
        tmp <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
NvimR.selection()
block = 4
        tmp <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
tmp
        tmp <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
tmp
NvimR.selection()
    blk <- NULL
    tmp <- biglist[[exp]]
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
blk
.conversion <- function(x) {
    out <- matrix(0, nrow = c(nrow(x)), ncol = c(ncol(x) * 3))
    # TODO: do it with paralell computing
    for (i in 1:ncol(x)) {
        fac <- (i - 1) * 3 + c(x[, i])
        # TODO: nested loops are a bit much
        for (j in 1:length(fac)) {
            out[j, fac[j]] <- 1
        }
    }
    return(out)
}
        blk <- .conversion(block)
        blk <- .conversion(blk)
blk
tmp
    tmp <- ret[[exp]]
    blk <- NULL
    makelist <- NULL
    biglist <- NULL
    for (i in 1:ppt) {
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
        blk <- .conversion(blk)
        makelist <- cbind(ppt, sort(rep(1:block, 27), blk))
        biglist <- cbind(biglist, makelist)
        blk <- NULL
    }
ppt=4
    for (i in 1:ppt) {
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
        blk <- .conversion(blk)
        makelist <- cbind(ppt, sort(rep(1:block, 27), blk))
        biglist <- cbind(biglist, makelist)
        blk <- NULL
    }
sort(rep(1:block, 27)
    for (i in 1:ppt) {
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
        blk <- .conversion(blk)
        makelist <- cbind(ppt, sort(rep(1:block, 27)), blk)
        biglist <- cbind(biglist, makelist)
        blk <- NULL
    }
biglist
    blk <- NULL
    makelist <- NULL
    biglist <- NULL
    for (i in 1:ppt) {
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
        blk <- .conversion(blk)
        makelist <- cbind(ppt, sort(rep(1:block, 27)), blk)
        biglist <- rbind(biglist, makelist)
        blk <- NULL
    }
biglist
    cbind(1:3, int3)
non3
    a3 <- c(1, 1, 1, 1, 1, 1, 0,
            1, 1, 1, 1, 2, 2, 0,
            1, 1, 1, 1, 3, 3, 0,
            1, 1, 2, 2, 1, 1, 0,
            1, 1, 2, 2, 2, 2, 0,
            1, 1, 2, 2, 3, 3, 0,
            1, 1, 3, 3, 1, 1, 0,
            1, 1, 3, 3, 2, 2, 0,
            1, 1, 3, 3, 3, 3, 0)
    b3 <- c(2, 2, 1, 1, 1, 1, 0,
            2, 2, 1, 1, 2, 2, 0,
            2, 2, 1, 1, 3, 3, 0,
            2, 2, 2, 2, 1, 1, 0,
            2, 2, 2, 2, 2, 2, 0,
            2, 2, 2, 2, 3, 3, 0,
            2, 2, 3, 3, 1, 1, 0,
            2, 2, 3, 3, 2, 2, 0,
            2, 2, 3, 3, 3, 3, 0)
    c3 <- c(3, 3, 1, 1, 1, 1, 0,
            3, 3, 1, 1, 2, 2, 0,
            3, 3, 1, 1, 3, 3, 0,
            3, 3, 2, 2, 1, 1, 0,
            3, 3, 2, 2, 2, 2, 0,
            3, 3, 2, 2, 3, 3, 0,
            3, 3, 3, 3, 1, 1, 0,
            3, 3, 3, 3, 2, 2, 0,
            3, 3, 3, 3, 3, 3, 0)
    non3 <- matrix(rbind(a3, b3, c3), ncol = 7, byrow = TRUE)
    non3[, 7] <- sample(rep(1:3, nrow(non3) / 3))
non3
    a3 <- c(1, 1, 1, 1, 1, 1, 0,
            1, 1, 1, 1, 2, 2, 0,
            1, 1, 1, 1, 3, 3, 0,
            1, 1, 2, 2, 1, 1, 0,
            1, 1, 2, 2, 2, 2, 0,
            1, 1, 2, 2, 3, 3, 0,
            1, 1, 3, 3, 1, 1, 0,
            1, 1, 3, 3, 2, 2, 0,
            1, 1, 3, 3, 3, 3, 0)
    b3 <- c(2, 2, 1, 1, 1, 1, 0,
            2, 2, 1, 1, 2, 2, 0,
            2, 2, 1, 1, 3, 3, 0,
            2, 2, 2, 2, 1, 1, 0,
            2, 2, 2, 2, 2, 2, 0,
            2, 2, 2, 2, 3, 3, 0,
            2, 2, 3, 3, 1, 1, 0,
            2, 2, 3, 3, 2, 2, 0,
            2, 2, 3, 3, 3, 3, 0)
    c3 <- c(3, 3, 1, 1, 1, 1, 0,
            3, 3, 1, 1, 2, 2, 0,
            3, 3, 1, 1, 3, 3, 0,
            3, 3, 2, 2, 1, 1, 0,
            3, 3, 2, 2, 2, 2, 0,
            3, 3, 2, 2, 3, 3, 0,
            3, 3, 3, 3, 1, 1, 0,
            3, 3, 3, 3, 2, 2, 0,
            3, 3, 3, 3, 3, 3, 0)
c3
    non3 <- matrix(rbind(a3, b3, c3), ncol = 7, byrow = TRUE)
non3
    non3 <- matrix(rbind(a3, b3, c3), ncol = 7) 
non3
    a3 <- matrix(c(1, 1, 1, 1, 1, 1, 0,
                 1, 1, 1, 1, 2, 2, 0,
                 1, 1, 1, 1, 3, 3, 0,
                 1, 1, 2, 2, 1, 1, 0,
                 1, 1, 2, 2, 2, 2, 0,
                 1, 1, 2, 2, 3, 3, 0,
                 1, 1, 3, 3, 1, 1, 0,
                 1, 1, 3, 3, 2, 2, 0,
                 1, 1, 3, 3, 3, 3, 0))
    a3 <- matrix(c(1, 1, 1, 1, 1, 1, 0,
                 1, 1, 1, 1, 2, 2, 0,
                 1, 1, 1, 1, 3, 3, 0,
                 1, 1, 2, 2, 1, 1, 0,
                 1, 1, 2, 2, 2, 2, 0,
                 1, 1, 2, 2, 3, 3, 0,
                 1, 1, 3, 3, 1, 1, 0,
                 1, 1, 3, 3, 2, 2, 0,
                 1, 1, 3, 3, 3, 3, 0), ncol = 7, byrow = TRUE)
a3
    a3 <- matrix(c(1, 1, 1, 1, 1, 1, 0,
                   1, 1, 1, 1, 2, 2, 0,
                   1, 1, 1, 1, 3, 3, 0,
                   1, 1, 2, 2, 1, 1, 0,
                   1, 1, 2, 2, 2, 2, 0,
                   1, 1, 2, 2, 3, 3, 0,
                   1, 1, 3, 3, 1, 1, 0,
                   1, 1, 3, 3, 2, 2, 0,
                   1, 1, 3, 3, 3, 3, 0),
                 ncol = 7, byrow = TRUE)
    b3 <- matrix(c(2, 2, 1, 1, 1, 1, 0,
                   2, 2, 1, 1, 2, 2, 0,
                   2, 2, 1, 1, 3, 3, 0,
                   2, 2, 2, 2, 1, 1, 0,
                   2, 2, 2, 2, 2, 2, 0,
                   2, 2, 2, 2, 3, 3, 0,
                   2, 2, 3, 3, 1, 1, 0,
                   2, 2, 3, 3, 2, 2, 0,
                   2, 2, 3, 3, 3, 3, 0),
                 ncol = 7, byrow = TRUE)
    c3 <- matrix(c(3, 3, 1, 1, 1, 1, 0,
                   3, 3, 1, 1, 2, 2, 0,
                   3, 3, 1, 1, 3, 3, 0,
                   3, 3, 2, 2, 1, 1, 0,
                   3, 3, 2, 2, 2, 2, 0,
                   3, 3, 2, 2, 3, 3, 0,
                   3, 3, 3, 3, 1, 1, 0,
                   3, 3, 3, 3, 2, 2, 0,
                   3, 3, 3, 3, 3, 3, 0),
                 ncol = 7, byrow = TRUE)
    non3 <- rbind(a3, b3, c3)
non3
    non3[, 7] <- sample(rep(1:3, nrow(non3) / 3))
    non3 <- cbind(sort(rep(1:3, 9)), non3)
non3
    int3 <- c(1, 1, 1, 0, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 3, 3, 3, 0, 0, 0, 0)
    int3 <- matrix(rep(int3, 9), ncol = 7, byrow = TRUE)
int3
int3[, 1]-int3[, 2]
    int2 <- matrix(c(1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, rep(0, 9)),
                   ncol = 7, nrow = 3)
int2
    int2 <- do.call(rbind, replicate(9, int2, simplify = FALSE))
    int2[, 5:7] <- matrix(sample(rep(1:3, 3)), ncol = 3)
int2
    int2 <- cbind(1:3, int2)
int2
    non2 <- matrix(c(1, 2, 3, 1, 2, 3, rep(0, 15)), ncol = 7, nrow = 3)
    non2 <- do.call(rbind, replicate(9, non2, simplify = FALSE))
    non2[, 3:7] <- matrix(sample(rep(1:3, 5)), ncol = 5)
non2
    non2 <- cbind(1:3, non2)
    ret <- list(non2, int2, non3, int3)
    tmp <- ret[[exp]]
    blk <- NULL
    makelist <- NULL
    biglist <- NULL
    for (i in 1:ppt) {
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
        blk <- .conversion(blk[, 2:8])
        makelist <- cbind(ppt, sort(rep(1:block, 27)), blk)
        biglist <- rbind(biglist, makelist)
        blk <- NULL
    }
biglist
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
blk
        blk <- .conversion(blk[, 2:8])
blk
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
        blk[, 2:8] <- .conversion(blk[, 2:8])
        blk <- cbind(blk[, 1], .conversion(blk[, 2:8]))
blk
        makelist <- cbind(ppt, sort(rep(1:block, 27)), blk)
        biglist <- rbind(biglist, makelist)
        biglist <- rbind(biglist, makelist)
    biglist <- NULL
        biglist <- rbind(biglist, makelist)
biglist
    tmp <- ret[[exp]]
    blk <- NULL
    makelist <- NULL
    biglist <- NULL
    for (i in 1:ppt) {
        blk <- do.call(rbind, replicate(block, tmp[sample(nrow(tmp)), ],
                                        simplify = FALSE))
        blk <- cbind(blk[, 1], .conversion(blk[, 2:8]))
        makelist <- cbind(3, ppt, exp, sort(rep(1:block, 27)), blk)
        makelist[1, 1] <- 4
        biglist <- rbind(biglist, makelist)
        blk <- NULL
    }
biglist
biglist[1, ]
    colnames(biglist) <- c("ctrl", "ppt", "exp", "blk", "stim",
                           "a1", "a2", "a3", "b1", "b2", "b3", "c1", "c2", "c3",
                           "d1", "d2", "d3", "e1", "e2", "e3", "f1", "f2", "f3",
                           "g1", "g2", "g3", "h1", "h2", "h3", "j1", "j2", "j3")
    colnames(biglist) <- c("ctrl", "ppt", "exp", "blk", "stim",
                           "a1", "a2", "a3", "b1", "b2", "b3", "c1", "c2", "c3",
                           "d1", "d2", "d3", "e1", "e2", "e3", "f1", "f2", "f3",
                           "g1", "g2", "g3")
biglist[1, ]
biglist
q()
